{% extends "improved_base.html" %}

{% block title %}TerraFusion Platform - Login{% endblock %}

{% block login_content %}
<div class="tf-login-card">
    <div class="tf-login-header">
        <div class="mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 1.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"/>
                <path d="M8 3.293L3.707 7.586a1 1 0 0 0-.293.707V13h10V8.293a1 1 0 0 0-.293-.707L8 3.293z"/>
                <path d="M7 10h2v2H7v-2z"/>
            </svg>
        </div>
        <h1 class="h3 mb-2">TerraFusion Platform</h1>
        <p class="text-light mb-0">Sign in to your account</p>
    </div>
    
    <div class="tf-card-body tf-p-4">
        <form id="login-form" action="/api/auth/login" method="post">
            <!-- Alert for error messages -->
            <div id="login-alert" class="alert alert-danger d-none" role="alert"></div>
            
            <div class="tf-form-group mb-3">
                <label for="username" class="tf-form-label">
                    Username
                    <span class="sr-only">(required)</span>
                </label>
                <div class="input-group">
                    <span class="input-group-text" id="username-addon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" aria-hidden="true" viewBox="0 0 16 16">
                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                        </svg>
                    </span>
                    <input 
                        type="text" 
                        class="tf-form-control" 
                        id="username" 
                        name="username" 
                        placeholder="Enter your username" 
                        aria-label="Username" 
                        aria-describedby="username-addon"
                        required 
                        autofocus
                        autocomplete="username">
                </div>
            </div>
            
            <div class="tf-form-group mb-4">
                <label for="password" class="tf-form-label">
                    Password
                    <span class="sr-only">(required)</span>
                </label>
                <div class="input-group">
                    <span class="input-group-text" id="password-addon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" aria-hidden="true" viewBox="0 0 16 16">
                            <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2zM5 8h6a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1z"/>
                        </svg>
                    </span>
                    <input 
                        type="password" 
                        class="tf-form-control" 
                        id="password" 
                        name="password" 
                        placeholder="Enter your password" 
                        aria-label="Password" 
                        aria-describedby="password-addon"
                        required
                        autocomplete="current-password">
                </div>
            </div>
            
            <div class="d-grid">
                <button type="submit" class="btn tf-btn tf-btn-primary" id="login-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z"/>
                        <path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                    </svg>
                    Sign In
                </button>
            </div>
        </form>
    </div>
    
    <div class="tf-card-footer tf-p-3">
        <div class="text-center">
            <p class="mb-1 text-muted">County Network Authentication</p>
            <p class="small text-muted mb-0">Use your County network credentials to sign in</p>
        </div>
    </div>
</div>

<!-- Authentication Help Card -->
<div class="tf-card mt-4" style="max-width: 440px;">
    <div class="tf-card-header">
        <h5 class="tf-card-title mb-0 d-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
            </svg>
            Authentication Help
        </h5>
    </div>
    <div class="tf-card-body">
        <p class="mb-2">Having trouble signing in?</p>
        <ul class="mb-0 ps-4">
            <li class="mb-2">Use your County network username and password</li>
            <li class="mb-2">Ensure your account has access to TerraFusion</li>
            <li>Contact IT support if you need assistance</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Enhanced JavaScript for form submission with better error handling
    document.addEventListener('DOMContentLoaded', function() {
        const loginForm = document.getElementById('login-form');
        const loginAlert = document.getElementById('login-alert');
        const loginButton = document.getElementById('login-button');
        const originalButtonText = loginButton.innerHTML;
        
        if (loginForm) {
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Show loading state
                loginButton.disabled = true;
                loginButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Signing in...';
                
                // Hide any previous errors
                loginAlert.classList.add('d-none');
                
                // Get form data
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                // Input validation
                if (!username || !password) {
                    showError('Please enter both username and password.');
                    return;
                }
                
                // Send request to login API
                fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        // Login successful - redirect to dashboard
                        window.location.href = '/';
                    } else {
                        // Login failed with a known error message
                        showError(data.message || 'Authentication failed. Please check your credentials.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    
                    // Handle different types of errors
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        showError('Network error. Please check your connection and try again.');
                    } else {
                        showError('An error occurred during authentication. Please try again later.');
                    }
                });
            });
        }
        
        function showError(message) {
            // Reset button state
            loginButton.disabled = false;
            loginButton.innerHTML = originalButtonText;
            
            // Show error message
            loginAlert.textContent = message;
            loginAlert.classList.remove('d-none');
            
            // Set focus to the first input field with an error
            if (!document.getElementById('username').value) {
                document.getElementById('username').focus();
            } else if (!document.getElementById('password').value) {
                document.getElementById('password').focus();
            }
        }
    });
</script>
{% endblock %}